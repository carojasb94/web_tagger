



{u'is_trap': True, u'estado_dispositivo': u'DOWN', u'ip': u'192.168.78.17', u'variables': u'ifIndex.19:19;ifDescr.19:GigabitEthernet3/15;ifType.19:ethernetCsmacd;enterprises.9.2.2.1.1.20.19:Lost Carrier', u'tipo_notificacion': u'PROBLEM', u'tipo_problema': u'SERVICE', u'descripcion': u'INTERFAZ DOWN - GigabitEthernet3/15', u'tipo_trap': u'Link'}





python crear_notificacion.py -D "192.168.78.40" -d "INTERFAZ DOWN - GigabitEthernet1/2" --tipo "PROBLEM" --eoequipo "DOWN" --variables "ifIndex.2:2;ifDescr.2:GigabitEthernet1/2;ifType.2:ethernetCsmacd;enterprises.9.2.2.1.1.20.2:Lost Carrier" --tipo_trap "Link"  --istrap

{u'is_trap': True, u'estado_dispositivo': u'UP', u'ip': u'192.168.78.17', u'variables': u'ifIndex.19:19;ifDescr.19:GigabitEthernet3/15;ifType.19:ethernetCsmacd;enterprises.9.2.2.1.1.20.19:up', u'tipo_notificacion': u'RECOVERY', u'tipo_problema': u'SERVICE', u'descripcion': u'INTERFAZ UP - GigabitEthernet3/15', u'tipo_trap': u'Link'}



python /usr/lib/nagios/plugins/crear_notificacion.py --dispositivo "192.168.78.17" -d "INTERFAZ UP - GigabitEthernet3/15" --tipo "RECOVERY" --eoequipo "UP" --variables "ifIndex.19:19;ifDescr.19:GigabitEthernet3/15;ifType.19:ethernetCsmacd;enterprises.9.2.2.1.1.20.19:up" --tipo_trap "Link"  --istrap



python /usr/lib/nagios/plugins/crear_notificacion.py --dispositivo "192.168.78.17" -d "INTERFAZ UP - GigabitEthernet3/15" --tipo "RECOVERY" --eoequipo "UP" --variables "ifIndex.19:19;ifDescr.19:GigabitEthernet3/15;ifType.19:ethernetCsmacd;enterprises.9.2.2.1.1.20.19:up" --tipo_trap "Link"  --istrap


python /usr/lib/nagios/plugins/crear_notificacion.py --dispositivo "192.168.78.3" -d "INTERFAZ UP - GigabitEthernet3/15" --tipo "PROBLEM" --eoequipo "DOWN" --variables "ospfRouterId:177.234.30.3;ospfNbrIpAddr:7.234.31.74;ospfNbrAddressLessIndex:0;ospfNbrRtrId:177.234.30.17;ospfNbrState:down" --tipo_trap "OSPF"  --istrap






$r="192.168.78.3";
/usr/bin/python /usr/lib/nagios/plugins/crear_notificacion.py --dispositivo "$r" --descripcion "OSPF: *" --tipo "PROBLEM" --eoequipo "DOWN" --variables "ospfRouterId:177.234.30.3;ospfNbrIpAddr:7.234.31.74;ospfNbrAddressLessIndex:0;ospfNbrRtrId:177.234.30.17;ospfNbrState:down" --tipo_trap "OSPF"  --istrap

/usr/bin/python /usr/lib/nagios/plugins/crear_notificacion.py --dispositivo "$r" --descripcion "OSPF: *" --tipo "PROBLEM" --eoequipo "DOWN" --variables "ospfRouterId:177.234.30.3;ospfNbrIpAddr:7.234.31.74;ospfNbrAddressLessIndex:0;ospfNbrRtrId:177.234.30.17;ospfNbrState:full" --tipo_trap "OSPF"  --istrap



177.234.30.3 7.234.31.74 0 177.234.30.17 full

snmptrap -v 2c -d -c E-m3x1c0 10.0.10.54 .1.3.6.1.2.1.14.16.2.0.2

snmptrap -v 2c -c public 10.0.10.54 UCD-TRAP-TEST-MIB::demotraps "" 6 17 "" SNMPv2-MIB::sysLocation.0 s "Just here"



Nov  9 17:10:59 debian54 snmptt[28575]: .1.3.6.1.6.3.1.1.5.3 Normal "Status Events" 192.168.78.3 - Thu Nov  9 2017  - 17:10:58 Link DOWN on interface 61  Admin state: GigabitEthernet4/3.  Operational state: ethernetCsmacd - $0 - administratively down - $5 --  4 - ifIndex.61:61;ifDescr.61:GigabitEthernet4/3;ifType.61:ethernetCsmacd;enterprises.9.2.2.1.1.20.61:administratively down



InterfacesDispositivosNiba.objects.get(gid="94761", gid_dispositivo=52)


############### CREAR TICKET 

python crear_ticket.py --host "HT-BC-GW10" --ip "192.168.78.34" --tipo "PROBLEM" --gid "4305401" --output "TEST:Creacion de Ticket Equipo NIBA" --descripcion "GID: 4305401" --conectividad "NIBA" --proveedor "OPERBES" --gidoperbes "94774" --ishost



### peticion que da lata por encoding de Ã‘

{u'is_trap': True, u'estado_dispositivo': u'DOWN', u'ip': u'192.168.78.1', u'variables': u'', u'tipo_notificacion': u'PROBLEM', u'tipo_problema': u'SERVICE', u'descripcion': u'OSPF: ospfRouterId:177.234.30.1;ospfNbrIpAddr:177.234.31.10;ospfNbrAddressLessIndex:0;ospfNbrRtrId:177.234.30.3;ospfNbrState:full', u'tipo_trap': u'OSPF'}


{u'is_trap': True, u'estado_dispositivo': u'DOWN', u'ip': u'192.168.78.3', u'variables': u'ospfRouterId:177.234.30.3;ospfNbrIpAddr:177.234.31.9;ospfNbrAddressLessIndex:0;ospfNbrRtrId:177.234.30.1;ospfNbrState:down', u'tipo_notificacion': u'PROBLEM', u'tipo_problema': u'SERVICE', u'descripcion': u'OSPF: ospfRouterId:177.234.30.3;ospfNbrIpAddr:177.234.31.9;ospfNbrAddressLessIndex:0;ospfNbrRtrId:177.234.30.1;ospfNbrState:down', u'tipo_trap': u'OSPF'}



python crear_notificacion.py --dispositivo "192.168.78.20" --descripcion "OSPF: DESCRIPCION DUMMY" --tipo "PROBLEM" --eoequipo "DOWN" --variables "ospfRouterId:177.234.30.20;ospfNbrIpAddr:177.234.31.57;ospfNbrAddressLessIndex:0;ospfNbrRtrId:177.234.30.1;ospfNbrState:full" --tipo_trap "OSPF"  --istrap






python crear_ticket.py --host "HT-BC-GW10" --ip "192.168.78.34" --tipo "PROBLEM" --gid "4305401" --output "TEST:Creacion de Ticket Equipo NIBA" --descripcion "GID: 4305401" --conectividad "NIBA" --proveedor "OPERBES" --gidoperbes "" --ishost


UTIC = OID 24 # VALOR DE PRUEBA
INTERFAZ PACHUCA 
	GI2/16 - 64
	GI2/17 - 65


/usr/lib/nagios/plugins/check_nrpe -H 10.0.10.54 -c check_nrpe_niba -a {0} {1} {2} {3}

host="10.0.10.54";tipo="snmp";comunidad="E-m3x1c0";interfaz=""
"/usr/lib/nagios/plugins/check_nrpe -H 10.0.10.54 -c check_nrpe_niba -a {0} {1} {2} {3}". format(host, tipo, comunidad, interfaz)
/usr/lib/nagios/plugins/check_nrpe -H 10.0.10.54 -c check_nrpe_niba -a 192.168.78.12 snmp E-m3x1c0 1


snmpwalk -v2c -c "E-m3x1c0" "192.168.78.12" -Ci "1.3.6.1.2.1.2.2.1.8.1"
snmp_set("1.3.6.1.2.1.2.2.1.8.1", 'My Cool Place', hostname="192.168.78.12", community="E-m3x1c0", version=2)
# Perform an SNMP walk
snmp_walk("1.3.6.1.2.1.2.2.1.8.1", hostname="192.168.78.12", community="E-m3x1c0", version=2)
# Grab a single piece of information using an SNMP GET

snmp_get("1.3.6.1.2.1.2.2.1.8.1", hostname="192.168.78.12", community="E-m3x1c0", version=2)
snmpwalk -v2c -c "E-m3x1c0" "192.168.78.43" -Ci "1.3.6.1.2.1.2.2.1.8.25"





python crear_notificacion.py -D "192.168.78.1" -d "TEST OSPF DE MADRUGADA #WantToSleep" --tipo "PROBLEM" --eoequipo "DOWN" --variables "ospfRouterId:177.234.30.3;ospfNbrIpAddr:177.234.31.9;ospfNbrAddressLessIndex:0;ospfNbrRtrId:177.234.30.1;ospfNbrState:down" --tipo_trap "OSPF"  --istrap


python crear_notificacion.py --dispositivo "192.168.78.20" --descripcion "TEST OSPF DE MADRUGADA #WantToSleep" --tipo "PROBLEM" --eoequipo "DOWN" --variables "ospfRouterId:177.234.30.3;ospfNbrIpAddr:177.234.31.9;ospfNbrAddressLessIndex:0;ospfNbrRtrId:177.234.30.1;ospfNbrState:down" --tipo_trap "OSPF"  --istrap




    vars.ping_cpl = 20    #2
    #  % = modified in '/usr/share/icinga2/include/command-plugins.conf', lines 50:2-50:19
    vars.ping_crta = 800  #80
    #  % = modified in '/usr/share/icinga2/include/command-plugins.conf', lines 49:2-49:21
    vars.ping_wpl = 2    #1
    #  % = modified in '/usr/share/icinga2/include/command-plugins.conf', lines 48:2-48:18
    vars.ping_wrta = 80  #60

home/user1/var_icinga2prod.tar.gz


python crear_ticket.py --host "HT-BC-GW10" --ip "192.168.78.34" --tipo "PROBLEM" --gid "4305401" --output "TEST:Creacion de Ticket Equipo NIBA" --descripcion "GID: 4305401" --conectividad "NIBA" --proveedor "OPERBES" --gidoperbes "94774" --ishost

{u'tipo_problema': u'HOST', u'comunidad_snmp': u'40-Cd-N1b@', u'ip': u'172.16.150.101', u'nombre_host': u'35768', u'gid': u'35768', u'tipo_notificacion': u'CUSTOM', u'interfaz_snmp': u'1', u'output_plugin': u'CRITICAL - Host Unreachable (172.16.150.101)', u'descripcion': u'35768 DOWN, GID: 35768', u'nombre_proveedor': u'TOTAL PLAY', u'red': u'40 redes'}



{u'tipo_problema': u'HOST', u'comunidad_snmp': u'40-Cd-N1b@', u'ip': u'172.16.105.130', u'nombre_host': u'36445', u'gid': u'36445', u'tipo_notificacion': u'PROBLEM', u'interfaz_snmp': u'1', u'output_plugin': u'PING CRITICAL - Packet loss = 50%, RTA = 68.72 ms', u'descripcion': u'36445 DOWN, GID: 36445', u'nombre_proveedor': u'TOTAL PLAY', u'red': u'40 redes'}

python crear_ticket.py --host "36445" --ip "172.16.105.130" --tipo "PROBLEM" --gid "36445" --output "PING CRITICAL - Packet loss = 50%, RTA = 68.72 ms" --descripcion "GID: 36445" --conectividad "40 redes" --proveedor "TOTAL PLAY"  --ishost

36400

SELECT h.gid,h.gid_st,h.programa_conectividad_red,h.nombre_estado,
h.nombre_proveedor,h.tipo_conectividad,h.comunidad,h.direccionamiento_ip,
h.oids,h.des_oids,eliminado
FROM dim_homologada h
INNER JOIN (
    SELECT distinct(sitio_key) as sitio_key
    FROM (
        SELECT sitio_key--,valido_desde
        FROM cc_direccionip di
        WHERE activo is true AND
              di.valido_desde >= current_timestamp  - interval '8 days'
        UNION
        SELECT distinct(sitio_key) as sitio_key
        FROM cc_todas_columnas
        WHERE columna_act IN ('oids','comunidad','des_oids','nombre_proveedor') AND fecha_actualizacion >= current_timestamp  - interval '8 days'
        GROUP BY sitio_key
        UNION
        SELECT sitio_key
        FROM dim_homologada h
        WHERE (h.valido_desde >= current_timestamp  - interval '8 days') OR
              (h.valido_hasta >= current_timestamp  - interval '8 days'  AND h.valido_hasta <= current_timestamp)
    ) unicos
) tmp USING (sitio_key)





{u'tipo_problema': u'HOST', u'comunidad_snmp': u'40-Cd-N1b@', u'ip': u'172.16.1.29', u'nombre_host': u'76305', u'gid': u'76305', u'tipo_notificacion': u'RECOVERY', u'interfaz_snmp': u'1', u'output_plugin': u'PING OK - Packet loss = 0%, RTA = 16.67 ms', u'descripcion': u'76305 DOWN, GID: 76305', u'nombre_proveedor': u'TOTAL PLAY', u'red': u'40 redes'}

python crear_ticket.py --host "36445" --ip "172.16.105.130" --tipo "PROBLEM" --gid "36445" --output "PING CRITICAL - Packet loss = 50%, RTA = 68.72 ms" --descripcion "GID: 36445" --conectividad "40 redes" --proveedor "TOTAL PLAY"  --ishost



**
{u'Campo_Reservado_5': u'40 redes', u'Campo_Reservado_1': u'35977', u'Campo_Reservado_2': u'172.16.126.33',
  'Description': u'Equipo Fuera de Linea GID: 35977', u'Detailed_Decription': u'Equipo - GID: 35977 - CRITICAL - Host Unreachable (172.16.126.33)', u'RFC_Corto_Contacto': u'usuario.UDG'}

# Emulando ticket con estatus de 'error ok' de cepra

python crear_ticket_local.py --host "35977" --ip "172.16.126.33" --tipo "PROBLEM" --gid "35977" --output "CRITICAL - Host Unreachable (172.16.126.33)" --descripcion "Equipo Fuera de Linea GID: 35977" --conectividad "40 redes" --proveedor "TOTAL PLAY"  --ishost


crear_notificacion_local.py --dispositivo "192.168.78.1" -d "INTERFAZ DOWN - GigabitEthernet3/15" --tipo "PROBLEM" --eoequipo "DOWN" --variables "ospfRouterId:177.234.30.2;ospfNbrIpAddr:177.234.31.1;ospfNbrAddressLessIndex:0;ospfNbrRtrId:177.234.30.1;ospfNbrState:down" --tipo_trap "OSPF"  --istrap



for property, value in vars(response).iteritems():
    print property, ": ", value
}











apt-get install libicinga2=2.7.2-1.xenial icinga2-bin=2.7.2-1.xenial icinga2-common=2.7.2-1.xenial icinga2-doc=2.7.2-1.xenial
dpkg --get-selections| grep icinga
sudo dpkg --force-all -r libicinga2 icinga2-doc icinga2-common 
sudo dpkg --force-all -P libicinga2 icinga2-doc icinga2-common 
sudo dpkg --force-all -r icinga2-common













morelia MAN N40	







